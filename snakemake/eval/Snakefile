#################### PREAMBLE
from snakemake.utils import min_version
min_version("6.0")


#################### CONFIG
configfile: "configs/snake_config_eval.yaml"


#################### INCLUDES
include: "../include/vcf-norm-call.smk"


#################### PARAMS
HEAD_DIR     = config["HEAD_DIR"]
SAMPLES      = config["SAMPLES"]


#################### RULES
rule all:
    input:
        expand(config["HEAD_DIR"] + "/data/simulated_hap{s}/callset.normalized.sorted.vcf.gz.tbi", s=SAMPLES),
        expand(config["HEAD_DIR"] + "/data/simulated_hap{s}/eval.picard.{e}", e=["variant_calling_detail_metrics", "variant_calling_summary_metrics"], s=SAMPLES),
        HEAD_DIR + "/results/variant_calling_summary_ngs"


rule vcf_evaluation:
    input:
        truthset = config["HEAD_DIR"] + "/data/simulated_hap{sample}/simulated.normalized.sorted.vcf.gz",
        truthidx = config["HEAD_DIR"] + "/data/simulated_hap{sample}/simulated.normalized.sorted.vcf.gz.tbi",
        callset  = config["HEAD_DIR"] + "/data/simulated_hap{sample}/callset.normalized.sorted.vcf.gz",
        callidx  = config["HEAD_DIR"] + "/data/simulated_hap{sample}/callset.normalized.sorted.vcf.gz.tbi"
    params:
        prefix   = config["HEAD_DIR"] + "/data/simulated_hap{sample}/eval.picard"
    output:
        detail   = config["HEAD_DIR"] + "/data/simulated_hap{sample}/eval.picard.variant_calling_detail_metrics",
        summary  = config["HEAD_DIR"] + "/data/simulated_hap{sample}/eval.picard.variant_calling_summary_metrics"
    #conda:
    #    config["HEAD_DIR"] + "/env/conda_picard.yaml"
    log:
        config["HEAD_DIR"] + "/logs/picard/evaluation_hap{sample}.log"
    shell:
        """
            picard CollectVariantCallingMetrics \
                --INPUT {input.callset} \
                --DBSNP {input.truthset} \
                -O {params.prefix}
        """


rule report:
    input:
        expand(config["HEAD_DIR"] + "/data/simulated_hap{sample}/eval.picard.variant_calling_summary_metrics", sample=config["SAMPLES"])
    output:
        config["HEAD_DIR"] + "/results/variant_calling_summary_ngs"
    params:
        head_dir = config["HEAD_DIR"]
    shell:
        """
            sh {params.head_dir}/aux/picard_summary_of_summaries.sh {params.head_dir} > {output}
        """